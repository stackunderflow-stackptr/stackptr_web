{% extends 'base.html' %}

{% block extra_head %}
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
{% endblock extra_head %}

{% block extra_css %}
	<link rel="stylesheet" type="text/css" href="/static/css/leaflet.css" />
	<link rel="stylesheet" type="text/css" href="/static/css/leaflet.draw.css" />
	<link rel="stylesheet" type="text/css" href="/static/css/index.css" />
	<style type="text/css">
		body {
			overflow: hidden;
		}
	</style>
{% endblock extra_css %}

{% block extra_js %}
	<script type="text/javascript" src="/static/js/leaflet.js"></script>
	<script type="text/javascript" src="/static/js/angular-leaflet-directive.min.js"></script>
	<script type="text/javascript" src="/static/js/angular-animate.min.js"></script>
	<script type="text/javascript" src="/static/js/angular-sanitize.min.js"></script>
	<script type="text/javascript" src="/static/js/angular-simple-logger.min.js"></script>
	<script type="text/javascript" src="/static/js/leaflet.draw.js"></script>
	<script type="text/javascript" src="/static/js/moment.min.js"></script>
	<script type="text/javascript" src="/static/js/angular-moment.min.js"></script>
	<script type="text/javascript" src="/static/js/angular-strap.min.js"></script>
	<script type="text/javascript" src="/static/js/angular-strap.tpl.min.js"></script>
	<script type="text/javascript" src="/static/js/autobahn.min.js"></script>
	<script type="text/javascript" src="/static/js/angular-wamp.js"></script>
	<script type="text/javascript" src="/static/js/stackptr-utils.js"></script>
	<script type="text/javascript" src="/static/js/stackptr-mapview.js"></script>
	<script type="text/javascript" src="/static/js/color-thief.min.js"></script>
{% endblock extra_js %}

{% block htmldef %}ng-app="StackPtr"{% endblock %}
{% block bodydef %}ng-controller="StackPtrMap"{% endblock %}

{% block content %}
<nav class="navbar navbar-fixed-top navbar-inverse semitransparent" role="navigation">
	<div class="navbar-header">
		<img src="/static/logo2.png" id="logo" height="50px">
	</div>
	<ul class="nav navbar-nav hidden-sm hidden-xs">
		<li><a onclick="togglePane('#usermenu')">Tracked Users</a></li>
		<li><a onclick="togglePane('#groupmenu')">Groups</a></li>
		<li><a href="/api/">Manage API keys</a></li>
	</ul>
	<ul class="nav navbar-nav navbar-right hidden-sm hidden-xs">
		<li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown">[[tiles.name]] <span class="caret"></span></a>
				<ul class="dropdown-menu" role="menu">
					<li ng-repeat="(tilename,tile) in tileservers"><a ng-click="setTileServer([[tilename]])">[[tile.name]]</a></li>
				</ul>
		</li>
		<li><a class="refreshtimer">[[status]]</a></li>
		<li><a href="/logout">Log out</a></li>
	</ul>
	
	<ul class="nav navbar-nav navbar-right visible-sm-block visible-xs-block">
		<li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown">Menu <span class="caret"></span></a>
			<ul class="dropdown-menu" role="menu">
				<li><a onclick="togglePane('#usermenu')">Tracked Users</a></li>
				<li><a onclick="togglePane('#groupmenu')">Groups</a></li>
				<li><a href="/api/">Manage API keys</a></li>
				<li class="divider"></li>
				<li ng-repeat="(tilename,tile) in tileservers"><a ng-click="setTileServer([[tilename]])">[[tile.name]]</a></li>
				<li class="divider"></li>
				<li><a class="refreshtimer">[[status]]</a></li>
				<li class="divider"></li>
				<li><a>Logged in as: {{ current_user }}</a></li>
				<li><a href="/logout">Log out</a></li>
			</ul>
		</li>
	</ul>
</nav>

<div class="panel panel-primary" id="usermenu">
	<div class="panel-heading">Tracked Users 
	<a onclick="togglePane('#usermenu')"><span class="glyphicon glyphicon-remove closebox pull-right"></span></a>
		
	</div>
	<div class="panel-body">
		
		<img width="32" height="32" class="user-icon" ng-src="[[userMe.icon]]" ng-click="center.lat = userMe.loc[0]; center.lng = userMe.loc[1]; center.zoom = 16">
		<span class="userme-label">[[userMe.username]]<span ng-if="userMe.lastupd > 0">, </span><span am-time-ago="userMe.lastupd" am-preprocess="unix" ng-if="userMe.lastupd > 0">,</span></span>
		
		<div ng-if="userMe.lastupd < 0">Your position has never been updated, insert information about mobile clients here...</div>
				
		<div ng-if="userListEmpty">Your user list is empty. Click the + to add someone.</div>
		
		<span ng-if="(hUsers = (userList | updateRange:0:60)).length"><div class="label" >&lt;1m ago</div></span>
		
		<img width="32" height="32" class="user-icon" ng-repeat="user in hUsers" ng-src="[[user.icon]]"
			data-trigger="hover" bs-tooltip data-placement="left" data-html="true"
			data-title="<b>[[user.username]]</b><br>Last update: [[user.lastupd * 1000 | amCalendar]]"
			ng-click="clickMarker(user)">

		<span ng-if="(hUsers = (userList | updateRange:60:3600)).length"><div class="label" >&lt;1h ago</div></span>
		
		<img width="32" height="32" class="user-icon" ng-repeat="user in hUsers" ng-src="[[user.icon]]"
			data-trigger="hover" bs-tooltip data-placement="left" data-html="true"
			data-title="<b>[[user.username]]</b><br>Last update: [[user.lastupd * 1000 | amCalendar]]"
			ng-click="clickMarker(user)">
		
		<span ng-if="(dUsers = (userList | updateRange:3600:86400)).length"><div class="label">&lt;1d ago</div></span>
		
		<img width="32" height="32" class="user-icon" ng-repeat="user in dUsers" ng-src="[[user.icon]]" 
			data-trigger="hover" bs-tooltip data-placement="left" data-html="true"
			data-title="<b>[[user.username]]</b><br>Last update: [[user.lastupd * 1000 | amCalendar]]"
			ng-click="clickMarker(user)">
		
		<span ng-if="(wUsers = (userList | updateRange:86400:604800)).length"><div class="label">&lt;1w ago</div></span>

		<img width="32" height="32" class="user-icon" ng-repeat="user in wUsers" ng-src="[[user.icon]]" 
			data-trigger="hover" bs-tooltip data-placement="left" data-html="true"
			data-title="<b>[[user.username]]</b><br>Last update: [[user.lastupd * 1000 | amCalendar]]"
			ng-click="clickMarker(user)">
		
		<span ng-if="(oUsers = (userList | updateRange:604800:-1)).length"><div class="label">&gt;1w ago</div></span>

		<img width="32" height="32" class="user-icon" ng-repeat="user in oUsers" ng-src="[[user.icon]]" 
			data-trigger="hover" bs-tooltip data-placement="left" data-html="true"
			data-title="<b>[[user.username]]</b><br>Last update: [[user.lastupd * 1000 | amCalendar]]"
			ng-click="clickMarker(user)">
		
		<span ng-if="!pendingListEmpty"><div class="label">Outgoing Requests</div></span>
		
		<img width="32" height="32" class="user-icon" ng-repeat="user in userPending" ng-src="[[user.icon]]" 
			data-trigger="click" bs-tooltip data-placement="left" data-html="true"
			data-title="<b>[[user.username]]</b><br><a onClick='delUserClick(this,[[user.id]])'>Cancel Request</a>">
		
		<span ng-if="!reqsListEmpty"><div class="label">Incoming Requests</div></span>
		
		<img width="32" height="32" class="user-icon" ng-repeat="user in userReqs" ng-src="[[user.icon]]" 
			data-trigger="click" bs-tooltip data-placement="left" data-html="true"
			data-title="<b>[[user.username]], [[user.id]]</b><br><a onClick='acceptUserClick(this,[[user.id]])'>Accept</a>
			<a onClick='delUserClick(this,[[user.id]])'>Delete</a>">
		
		
		<!--
		<div class="list-group" id="userlist">
			<a href="" class="list-group-item list-item-person" ng-repeat="user in userList" bs-tooltip="tooltip" data-placement="left">
				<img width="24" height="24" ng-src="[[user.icon]]">
				 !-- [[user.hdg]] -- 
				<span class="glyphicon glyphicon-plus pull-right"></span><br>
			</a>
		</div>
		-->
		
		<!--
		<form class="form-horizontal" role="form" method="POST" action="/adduser" id="adduserform">
			<div class="form-group">
				<div class="col-lg-6">
					<input type="text" class="form-control" name="username">
				</div>
				<div class="col-lg-6">
					<button type="submit" id="adduser" class="btn btn-default">+</button>
					<button id="goto_loc" class="btn btn-warning">Me</button>
				</div>
			</div>
		</form>
		<div id="addstatus"></div>
		-->
		<br><br>
		&nbsp;<span class="glyphicon glyphicon-plus">&nbsp;</span>
		
		<form class="input-group input-group-sm">
			<input type="text" name="user" class="form-control" value="">
			<span class="input-group-btn">
				<button class="btn btn-default" type="button" ng-click="addUser($event)">Add</button>
			</span>
		</form>	
		
	</div>
</div>

<div class="panel panel-primary" id="groupmenu">
	<div class="panel-heading">Groups <a onclick="togglePane('#groupmenu')"><span class="glyphicon glyphicon-remove closebox pull-right"></span></a></div>
	<div class="panel-body" id="groupmenu_content">
		<form class="form-horizontal" role="form" method="POST" action="/selectgroup" id="selectgroupform">
			<div class="form-group">
				<div class="col-lg-12">
					<select class="form-control" name="groupname" id="selectgroup">
						<option value="[[id]]" ng-repeat="(id,name) in grouplist">[[name]]</option>
					</select>
				</div>
			</div>
		</form>
		
		<div class="list-group" id="groupfeaturelist" bs-collapse ng-model="activePanel" ng-animation="am-fade">
		<span id="feature-[[item.json.id]]" class="list-group-item list-item-draw" ng-repeat="item in groupdata">
			<span class="icon_type icon_[[item.json.geometry.type]]">&nbsp;</span>
			<a ng-click="gotoItem(item.json.id)">[[item.name]]</a>
			<span class="glyphicon glyphicon-pencil pull-right" bs-collapse-toggle></span>
			<div class="panel-collapse" bs-collapse-target>
				<br>
				<form class="input-group input-group-sm">
					<input type="text" name="name" class="form-control" value="[[item.name]]">
					<input type="hidden" name="id" value="[[item.json.id]]">
					<span class="input-group-btn">
						<button class="btn btn-default" type="button" ng-click="renameGroupItem($event)">Rename</button>
					</span>
					<span class="input-group-btn">
						<button class="btn btn-danger" type="button" ng-click="removeGroupItem($event)">Remove</button>
					</span>
				</form>
				<b>Created by</b>: [[ item.owner ]]<br>
				<b>Type</b>: [[item.json.geometry.type]]<br>
				<b>ID</b>: [[item.json.id]]<br>
			</div>
		</span>
		</div>

	</div>
</div>

<div class="fill">
		<leaflet defaults="defaults" geojson="geojson" controls="controls" markers="markers" center="center" tiles="tiles" event-broadcast="events" paths="paths" layers="layers" height="100%"></leaflet>
</div>

{% endblock content %}